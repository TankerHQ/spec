# Concepts

The *Tanker SDK* provides security based on the principle of separation of knowledge between the *Tanker server*, the *user* and the *application server*.
To establish trust between these actors and to enable sharing of encrypted *data* between *user*s, the *Tanker SDK* produces and uses cryptographic keys, IDs, and tokens.
The following section describes these elements, how they are generated, used, and, when applicable, stored.
It should be noted that they are only valid within a single *Trustchain*.

![IDs and keys ownership](./img/keys.png)

## Summary


<dl>
  <dt>Device Encryption Key Pair (DEK)</dt>
  <dd>Used to encrypt the user keys</dd>

 <dt>Device ID (DID)</dt>
 <dd>Unique identifier of a device belonging to a user</dd>

 <dt>Device Signature Key Pair (DSK)</dt>
 <dd>Used when the users signs a block - like the addition of a new device</dd>

 <dt>Group Encryption Key Pair (GEK)</dt>
 <dd>Used when sharing data securely within a group</dd>

 <dt>Group Signature Key Pair (GSK)</dt>
 <dd>Used when the user modifies a group - like adding a new member to it</dd>

 <dt>Local Encrypted Storage (LES)</dt>
 <dd>A place where sensitive data is stored, encrypted at rest</dd>

 <dt>Resource Encryption Key (REK)</dt>
 <dd>A symmetric key that can be exchanged securely across users</dd>

 <dt>Shared Encrypted Key (SEK)</dt>
 <dd>The result of encrypting a Resource Encryption Key</dd>

 <dt>Trustchain Signature Key Pair (TSK)</dt>
 <dd>Root of the Trustchain - used to sign user additions</dd>

 <dt>User Encryption Key Pair (UEK)</dt>
 <dd>Used for sharing encrypted keys across users. It is rotated when a device is revoked</dd>

 <dt>User ID (UID)</dt>
 <dd>Unique identifier of a user</dd>

 <dt>Unlock Key (ULK)</dt>
 <dd>An opaque token that allows creating new devices</dd>

 <dt>User Secret (US)</dt>
 <dd>A secret generated and stored on the application server that protects the local encrypted storage</dd>

 <dt>Secret Permanent Identity (SPerID)</dt>
 <dd>An opaque string containing private data about user's identity</dd>

 <dt>Public Permanent Identity (PPerID)</dt>
 <dd>Generated from a Secret Permanent Identity - essentialy equivalent to a user ID</dd>

 <dt>Secret Provisional Identity (SProID)</dt>
 <dd>Same as Secret Permanent Identity, but for a user not registered on the Trustchain yet</dd>

 <dt>Public Provisional Identity (PProID)</dt>
 <dd>Same as Public Permanent Identity, but for a user not registered on the Trustchain yet</dd>
</dl>

[Device Encryption Key Pair]: concepts.md#device-keys "(DEK)"
[Device ID]: concepts.md#device-id "(DID)"
[Device Signature Key Pair]: concepts.md#device-keys "(DSK)"
[Group Encryption Key Pair]: concepts.md#user-group-keys "(GEK)"
[Group Signature Key Pair]: concepts.md#user-group-keys "(GSK)"
[Local Encrypted Storage]: concepts.md#device-id "(LES)"
[Resource Encryption Key]: concepts.md#resource-keys "(REK)"
[Shared Encrypted Key]: concepts.md#resource-keys "(SEK)"
[Trustchain Signature Key Pair]: concepts.md#trustchain-keys "(TSK)"
[User Encryption Key Pair]: concepts.md#user-keys "(UEK)"
[User ID]: concepts.md#user-id "(UID)"
[Unlock Key]: concepts.md#unlock-key "(ULK)"
[User Secret]: concepts.md#user-secret "(US)"
[Secret Permanent Identity]: concepts.md#secret-permanent-identity "(SPerID)"
[Public Permanent Identity]: concepts.md#public-permanent-identify "(PPerID)"
[Secret Provisional Identity]: concepts.md#secret-provisional-identity "(SProID)"
[Public Provisional Identity]: concepts.md#public-provisional-identity "(PProID)"

## Trustchain keys

A *Trustchain* is identified by a unique ID, a name, and a [Trustchain Signature Key Pair] (TSK).
The name is informative and is never used in the SDK.
The public part of the TSK is included in the *Trustchain*'s root *block*.
The *Trustchain* ID is actually the hash of the *Trustchain* root *block*.

The TSK is generated client-side by the *customer* using the [Tanker dashboard](https://dashboard.tanker.io) during the *Trustchain* creation.
As such, it is only known by the *customer* and cannot be recovered by *Tanker* in any way.

## User ID

The [User ID] (UID) identifies a *user* on the *Trustchain*.
It is provided by the *application* when the *user* is created, and is part of the user's [Secret Permanent Identity] (SPerID).
The *Tanker SDK* cryptographically hashes *User ID*s locally before sending them to the *Tanker server*.

## User secret

The [User Secret] is a symmetric key, randomly generated by the *application server* for each *user*.
It is part of the [Secret Permanent Identity], and is considered an implementation detail not exposed in the Tanker API.
The user secret cannot be changed once the first *user*'s *device* has been created.
It is used to encrypt and decrypt the [Local Eencrypted Storage] and the [Unlock Key] stored by the *unlock service*.

## Delegation token

A delegation token is proof of the *user*'s authentication with the *application server*. It is generated when the *user* opens their first session in the *Tanker SDK*.
The delegation token is composed of an ephemeral signature key pair, a delegation signature, and the [User ID].
The delegation signature is created by combining the ephemeral public key and the [User ID], then signing the result with the private [Trustchain Signature Key Pair].
The delegation token is only used when the *user* creates their first *device* on the *Trustchain*, to sign the first `device_creation` *block* of that *user*.

## Secret Permanent Identity

The [Secret Permanent Identity] (SPerID) is generated and stored by the *application* and provided to a user only after successful authentication against the *application server*.
It should never be shared with other *user*s.
It contains some secret key material such as the [User Secret] and [delegation token](#delegation-token).
It represents the identity of the *user* for the *Tanker SDK* and is considered a proof of authentication against the *application server*.

## Public Permanent Identity

A [Public Permanent Identity] (PPerID) can be generated from a [Secret Permanent Identity], and is used to uniquely identify a *user*.
It contains a [User ID], but no secret key material and it is safe to share publicly.

## Device ID

Each *user* must have at least one *device*. *Device*s are identified in the *Tanker SDK* by a randomly attributed [Device ID] (DID). Each *device* has a [Local Clear Storage] (LCS) and a [Local Encrypted Storage] (LES).

## Device keys

Each *device* registered on the *Trustchain* has one [Device Encryption Key Pair] (DEK) and one [Device Signature Key Pair] (DSK).
Device keys are stored in the *device*'s [Local Encrypted Storage]. They are never replaced or modified after creation.
The public [Device Encryption Key Pair] and [Device Signature Key Pair] are pushed to the *Trustchain* in the `device_creation` *block*.
The private [Device Encryption Key Pair] and [Device Signature Key Pair] never leave the *device*.

## User keys

Every *user* registered on the *Trustchain* has one active [User Encryption Key Pair] (UEK).
User keys are stored in each *device*'s [Local Encrypted Storage].
The Private [User Encryption Key Pair] is encrypted with each of the *user*'s *device*s' public [Device Encryption Key Pair] before being pushed to the *Trustchain*.
It is pushed to the *Trustchain* in the `device_creation` *block* and updated whenever a *device* is revoked.

## User group keys

A *user group* has one [Group Encryption Key Pair] (GEK) and one [Group Signature Key Pair] (GSK).
*User group* keys are stored in the *device*'s [Local Encrypted Storage].
The private [Group Signature Key Pair] is encrypted with the private [Group Eencryption Key Pair], which is encrypted with each *group member*'s [User Encryption Key Pair].
They are pushed to the *Trustchain* in the `user_group_creation` *block* and updated whenever a *group member* is removed from a *user group*.

## Resource keys

A new [Resource Encryption Key] (REK) is randomly generated each time a *user* encrypts *data*.
The *data* is symmetrically encrypted with the [Resource Encryption Key].
The [Resource Encryption Key] can be encrypted for *user*s or *user group*s.
When sharing a resource key with a *user*, the [Resource Encryption Key] is encrypted using the [User Encryption Key Pair] of that *user* creating a [Shared Encryption Key] (SEK).
When sharing a resource key with a *user group*, the [Resource Encryption Key] is encrypted using the [Group Encryption Key Pair] of that *user group* creating a [Sared Encryption Key] (SEK).
[Share Encryption Key]s are pushed to the *Trustchain* in `key_publish` *block*s.
When received by a *device*, they are stored in the [Local Encrypted Storage].

## Unlock key

Once a session has been opened for the first time, it is highly advised to generate an [Unlock Key] (ULK) to be able to register new *device*s.
When generating an unlock key, an *unlock device* is created and pushed to the *Trustchain*.
The created [Device Encryption Key Pair] and [Device Signature Key Pair] are not saved in the [Local Encrypted Storage] but serialized in an opaque token: the [Unlock Key].

## Secret Provisional Identity

A [Secret Provisional Identity] (SProID) represents the identity of a user that is not yet registered on Tanker. It is split into two halves that are stored on the *application server* and on *Tanker server*s.
A provisional identity is attached to some authentication methods. For the moment only email is supported.
Each half contains the name of the authentication method, a value (in case of email, the value is the email address), and encryption and signature key pairs.

## Public Provisional Identity

A [Public Provisional Identity] (PProID) can be generated from a [Secret Provisional Identity] and consists of the [Secret Provisional Identity] without its secrets parts.

